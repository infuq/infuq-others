<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>杂货柜-商品库存</title>
    <link href="../r/libs/font-awesome/4.0.3/css/font-awesome.min.css" media="screen" rel="stylesheet" type="text/css">
    <link href="../r/element-ui@2.15.2/index.css" rel="stylesheet" />
    <link href="../r/css/common.css" rel="stylesheet" />

    <script src="../r/vue@2.6.14/vue.js"></script>
    <script src="../r/element-ui@2.15.2/index.js"></script>
    <script src="../r/axios@0.21.1/axios.min.js"></script>
    <script src="../r/js/route.js"></script>

    <style>
        .el-step__title.is-process {
            font-size: 15px;
        }

        .el-divider__text.is-left {
            color: #FA8919;
            font-weight: bold;
        }
        .el-tooltip__popper {
            max-width: 40%;
        }

        .el-input__inner {
            border-radius: 0 4px 4px 0;
        }
        .el-select {
            vertical-align: middle;
        }

        .demo-table-expand {
            font-size: 0;
        }
        .demo-table-expand label {
            width: 90px;
            color: #99a9bf;
        }
        .demo-table-expand .el-form-item {
            margin-right: 0;
            margin-bottom: 0;
            width: 50%;
        }

    </style>

</head>
<body>

<div id="app" style="margin-top: 5%;">

    <section class="content clearfix">
        <div>
            <div class="el-backtop" style="right: 40px; top: 130px;"><el-link  type="primary" :href="'/'" :underline="false" target="_blank"><i class="el-icon-s-home"></i></el-link></div>

            <el-divider content-position="right">{{env}}环境</el-divider>
            <el-form :inline="true" class="demo-form-inline">

                <div>
                    <div style="display: inline-block; margin-top: 3px; margin-bottom: 3px;">
                        <div style="display: inline-block;
                            background-color: rgb(245, 247, 250);
                            color: rgb(144, 147, 153);
                            border: 1px solid rgb(220, 223, 230);
                            border-radius: 4px 0px 0px 4px;
                            height: 40px;
                            width: 50px;
                            vertical-align: middle;
                            text-align: center;
                            margin-top: auto;
                            margin-right: -6px;
                            padding-top: 9px;
                            font-size: 14px;">
                            仓库
                        </div>
                        <el-select v-model="select_warehouse" placeholder="请选择仓库" @change="selectWarehouse(select_warehouse)" filterable clearable @clear="clearWarehouse">
                            <el-option v-for="item in WarehouseOptions" :key="item.value" :label="item.label" :value="item.value"></el-option>
                        </el-select>
                    </div>

                    <el-input v-model="goodsName" placeholder="商品名称" clearable @clear="clearGoodsName" style="width: 400px;">
                        <template slot="prepend">商品名称</template>
                    </el-input>

                    <el-input v-model="goodsOwnerName" placeholder="货主" clearable @clear="clearGoodsOwnerName" style="width: 300px;">
                        <template slot="prepend">货主</template>
                    </el-input>


                    <div style="display: inline-block; margin-top: 3px; margin-bottom: 3px;">
                        <el-button type="primary" @click="onSubmit(-1)">查询</el-button>
                        <!--
                        <el-button type="danger" @click="onSubmit2()">修复库存</el-button> -->
                    </div>
                </div>
                <div>
                    <el-input v-model="warehouse_owner_goods_code" placeholder="STOCK20220401175506943hpQU" clearable @clear="clear_warehouse_owner_goods_code" style="width: 400px;">
                        <template slot="prepend">STOCK码</template>
                    </el-input>

                    <div style="display: inline-block; margin-top: 3px; margin-bottom: 3px;">
                        <el-button type="primary" @click="onSubmit(-2)">查询</el-button>
                    </div>
                </div>
                <div>
                    <el-input v-model="business_no" placeholder="NULL-0001-000032 或 388404498978394112" clearable @clear="clear_business_no" style="width: 600px;">
                        <template slot="prepend">仓库货主商品编码或仓库货主商品主键</template>
                    </el-input>

                    <div style="display: inline-block; margin-top: 3px; margin-bottom: 3px;">
                        <el-button type="primary" @click="onSubmit(-3)">查询</el-button>
                    </div>
                </div>

                <!-- 结果 -->
                <div style="margin-top: 15px;">

                    <!-- 结果 -->
                    <div style="margin-top: 10px;" v-loading="loading">
                        <el-divider content-position="left">结果</el-divider>

                        <div style="font-weight: 500; font-size: 14px;">
                            <template>
                                <el-table :data="swogList" border style="width: 100%" :row-style="{ height: 10+'px'}" :cell-style="{padding:0+'px'}"> <!-- height="250" -->
                                    <el-table-column fixed type="expand">
                                        <template slot-scope="props">
                                            <el-form label-position="left" inline class="demo-table-expand">

                                                <div style="margin-left: 40px; font-weight: 500; font-size: 14px;">
                                                    <div style="width: 400px; display: block; margin: 5px 0;">
                                                        <label style="display: inline-block; width: 130px; text-align: right;">历史商品名称:</label><label>&nbsp;&nbsp;<el-button @click="handleGoodsNameHistoryClick(props.row)" type="text" >查看</el-button>
                                                    </label>
                                                    </div>
                                                </div>
                                                <div style="margin-left: 40px; font-weight: 500; font-size: 14px;">
                                                    <div style="width: 400px; display: block; margin: 5px 0;">
                                                        <label style="display: inline-block; width: 130px; text-align: right;">OMS商品编码:</label><label>&nbsp;&nbsp;&nbsp;{{props.row.externalGoodsNo}}&nbsp;&nbsp;<span v-if="props.row.externalGoodsNo != null && props.row.externalGoodsNo != ''"><i @click="copy(props.row.externalGoodsNo)" class="el-icon-document-copy"></i></span></label>
                                                    </div>
                                                </div>
                                                <div style="margin-left: 40px; font-weight: 500; font-size: 14px;">
                                                    <div style="width: 400px; display: block; margin: 5px 0;">
                                                        <label style="display: inline-block; width: 130px; text-align: right;">仓库货主商品编码:</label><label>&nbsp;&nbsp;&nbsp;{{props.row.warehouseOwnerGoodsNo}}&nbsp;&nbsp;<i @click="copy(props.row.warehouseOwnerGoodsNo)" class="el-icon-document-copy"></i></label>
                                                    </div>
                                                </div>
                                                <div style="margin-left: 40px; font-weight: 500; font-size: 14px;">
                                                    <div style="width: 400px; display: block; margin: 5px 0;">
                                                        <label style="display: inline-block; width: 130px; text-align: right;">STOCK码:</label><label>&nbsp;&nbsp;&nbsp;{{props.row.thirdNo}}&nbsp;&nbsp;<span v-if="props.row.thirdNo != null && props.row.thirdNo != ''"><i @click="copy(props.row.thirdNo)" class="el-icon-document-copy"></i></span></label>
                                                    </div>
                                                </div>
                                                <div style="margin-left: 40px; font-weight: 500; font-size: 14px;">
                                                    <div style="width: 400px; display: block; margin: 5px 0;">
                                                        <label style="display: inline-block; width: 130px; text-align: right;">仓库名称:</label><label>&nbsp;&nbsp;&nbsp;{{props.row.warehouseName}}&nbsp;&nbsp;<i @click="copy(props.row.warehouseName)" class="el-icon-document-copy"></i></label>
                                                    </div>
                                                </div>
                                                <div style="margin-left: 40px; font-weight: 500; font-size: 14px;">
                                                    <div style="width: 400px; display: block; margin: 5px 0;">
                                                        <label style="display: inline-block; width: 130px; text-align: right;">仓库编码:</label><label>&nbsp;&nbsp;&nbsp;{{props.row.warehouseCode}}&nbsp;&nbsp;<i @click="copy(props.row.warehouseCode)" class="el-icon-document-copy"></i></label>
                                                    </div>
                                                </div>
                                                <div style="margin-left: 40px; font-weight: 500; font-size: 14px;">
                                                    <div style="width: 400px; display: block; margin: 5px 0;">
                                                        <label style="display: inline-block; width: 130px; text-align: right;">货主名称:</label><label>&nbsp;&nbsp;&nbsp;{{props.row.customerName}}&nbsp;&nbsp;<i @click="copy(props.row.customerName)" class="el-icon-document-copy"></i></label>
                                                    </div>
                                                </div>
                                                <div style="margin-left: 40px; font-weight: 500; font-size: 14px;">
                                                    <div style="width: 400px; display: block; margin: 5px 0;">
                                                        <label style="display: inline-block; width: 130px; text-align: right;">货主编码:</label><label>&nbsp;&nbsp;&nbsp;{{props.row.customerNo}}&nbsp;&nbsp;<i @click="copy(props.row.customerNo)" class="el-icon-document-copy"></i></label>
                                                    </div>
                                                </div>

                                            </el-form>
                                        </template>
                                    </el-table-column>

                                    <el-table-column fixed label="序号" type="index" width="50">
                                        <template slot-scope="scope">
                                            <span v-if="scope.row.availableQuantity < 0 || scope.row.outFrozenQuantity < 0 || scope.row.availableSaleCount < 0">
                                                <span style="color: red;">{{scope.$index + 1}}</span>
                                            </span>
                                            <span v-else>
                                                {{scope.$index + 1}}
                                            </span>
                                        </template>
                                    </el-table-column>

                                    <el-table-column fixed label="商品名称" min-width="150" :show-overflow-tooltip="true">
                                        <template slot-scope="scope">
                                            <i @click="copy(scope.row.goodsName)" class="el-icon-document-copy"></i>
                                            <el-button @click="handleGoodsBatchHistoryClick(scope.row)" type="text" >{{ scope.row.goodsName }}</el-button>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="goodsNo" label="商品编码" width="100"></el-table-column>
                                    <!--
                                    <el-table-column prop="externalGoodsNo" label="OMS商品编码" width="180" :show-overflow-tooltip="true"></el-table-column>
                                    <el-table-column prop="warehouseOwnerGoodsNo" label="仓库货主商品编码" width="170" :show-overflow-tooltip="true"></el-table-column> -->
                                    <el-table-column prop="thirdNo" label="STOCK码" min-width="150" :show-overflow-tooltip="true"></el-table-column>

                                    <el-table-column prop="warehouseName" min-width="80" :show-overflow-tooltip="true">
                                        <template slot-scope="scope" slot="header">
                                            <span style="color: #da87ca;">仓库名称</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="warehouseCode" min-width="80" :show-overflow-tooltip="true">
                                        <template slot-scope="scope" slot="header">
                                            <span style="color: #da87ca;">仓库编码</span>
                                        </template>
                                    </el-table-column>

                                    <el-table-column prop="customerName" min-width="80" :show-overflow-tooltip="true">
                                        <template slot-scope="scope" slot="header">
                                            <span style="color: #d4b219;">货主名称</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="customerNo" min-width="80" :show-overflow-tooltip="true">
                                        <template slot-scope="scope" slot="header">
                                            <span style="color: #d4b219;">货主编码</span>
                                        </template>
                                    </el-table-column>

                                    <el-table-column label="已删除" width="100">
                                        <template slot-scope="scope">
                                            <span v-if="scope.row.deleted == null || scope.row.deleted != 0">
                                                <svg t="1691468608589" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4016" width="16" height="16"><path d="M414.245926 751.028148l437.57037-453.12c7.300741-7.49037 7.111111-19.531852-0.474074-26.832593-7.49037-7.300741-19.531852-7.111111-26.832593 0.474074L398.506667 712.722963 199.111111 513.327407c-7.395556-7.395556-19.437037-7.395556-26.832593 0l0 0c-7.395556 7.395556-7.395556 19.437037 0 26.832593l212.574815 212.574815c6.731852 6.731852 17.161481 7.300741 24.557037 1.896296C411.211852 753.682963 412.823704 752.545185 414.245926 751.028148z" fill="#d4237a" p-id="4017"></path></svg>
                                            </span>
                                        </template>
                                    </el-table-column>

                                    <el-table-column prop="availableQuantity" width="110">
                                        <template slot-scope="scope" slot="header">
                                            <span>
                                              可用库存
                                              <el-tooltip :aa="scope" class="item" effect="dark" content="store_batch_details#availableQuantity" placement="top-start">
                                                  <i class= 'el-icon-warning' style="color:#409eff; margin-left:5px;'"> </i>
                                              </el-tooltip>
                                            </span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column width="110">
                                        <template slot-scope="scope" slot="header">
                                            <span>
                                              冻结库存
                                              <el-tooltip :aa="scope" class="item" effect="dark" content="store_batch_details#outFrozenQuantity" placement="top-start">
                                                  <i class= 'el-icon-warning' style="color:#409eff; margin-left:5px;'"> </i>
                                              </el-tooltip>
                                            </span>
                                        </template>

                                        <template slot-scope="scope">
                                            <span v-if="scope.row.outFrozenQuantity > 0">
                                                <el-button @click="handleFrozenQuantityClick(scope.row)" type="text" >{{ scope.row.outFrozenQuantity }}</el-button>
                                            </span>
                                            <span v-else>
                                                <span>{{ scope.row.outFrozenQuantity }}</span>
                                            </span>
                                        </template>

                                    </el-table-column>

                                    <el-table-column prop="availableSaleCount">
                                        <template slot-scope="scope" slot="header">
                                            <span>
                                              可售库存
                                              <el-tooltip :aa="scope" class="item" effect="dark" content="库存数量-待出库数量-已售库存-过期库存-待调拨数量" placement="top-start">
                                                  <i class= 'el-icon-warning' style="color:#409eff; margin-left:5px;'"> </i>
                                              </el-tooltip>
                                            </span>
                                        </template>
                                        <template slot-scope="scope">
                                            <span>
                                                <span style="display: inline-block; width: 150px;">
                                                    <span v-if="scope.row.soldQuantity > 0 || scope.row.noAllocateCount > 0">
                                                        <span v-if="scope.row.availableSaleCount < 0">
                                                            <el-button @click="handleSoldQuantityClick(scope.row)" type="text" ><span style="color: red;">{{ scope.row.availableSaleCount }}</span></el-button>
                                                        </span>
                                                        <span v-else>
                                                            <el-button @click="handleSoldQuantityClick(scope.row)" type="text" >{{ scope.row.availableSaleCount }}</el-button>
                                                        </span>
                                                    </span>

                                                    <el-tooltip effect="dark" placement="bottom" >
                                                    <div slot="content">
                                                        {{ scope.row.availableSaleCountStr }}
                                                    </div>
                                                    <i class= 'el-icon-warning' style="color:#409eff; margin-left:5px;'"></i>
                                                </el-tooltip>
                                                </span>

                                            </span>
                                        </template>
                                    </el-table-column>


                                    <el-table-column fixed="right" label="操作">
                                        <template slot-scope="scope">
                                            <span v-if="scope.row.syncStockToOms == 1">
                                                <el-button @click="syncStockToOms(scope.row)" type="text">同步库存</el-button>
                                            </span>
                                        </template>
                                    </el-table-column>

                                </el-table>
                            </template>


                            <el-dialog :title="'[' + DETAIL_INDEX + '][ ' + GoodsName_Batch + ' ] 库存操作记录'" :visible.sync="GoodsBatchClick_dialogVisible" :show-close="false" width="80%">

                                <el-select v-model="select_batch" placeholder="请选择批次" @change="selectBatch()" filterable>
                                    <el-option v-for="item in BatchOptions" :key="item.value" :label="item.label" :value="item.value"></el-option>
                                </el-select>
                                <el-select v-model="select_batch_detail" placeholder="请选择库位" @change="selectBatchDetail(1)" filterable >
                                    <el-option v-for="item in BatchDetailOptions" :key="item.value" :label="item.label" :value="item.value"></el-option>
                                </el-select>
                                <span style="display: inline; margin-left: 25px;" v-if="GoodsBatchDetailHistoryTotal > 0">
                                    <span >共计{{GoodsBatchDetailHistoryTotal}}条记录</span>
                                    &nbsp;&nbsp;<i @click="copy(GoodsBatchDetailHistorySQL)" class="el-icon-document-copy"></i>SQL
                                </span>
                                <span style="display: inline; margin-left: 25px;" v-if="GoodsBatchDetailHistoryErrorTotal > 0">
                                    <el-button @click="handleFixStockClick(select_batch_detail)" type="text" >修复库存({{GoodsBatchDetailHistoryErrorTotal}}条)</el-button>
                                </span>
                                <span style="display: inline; margin-left: 25px;" v-if="(GoodsBatchDetailHistoryAvailableQuantity + GoodsBatchDetailHistoryOutFrozenQuantity) != GoodsBatchDetailHistoryLastAfterQuantity">
                                    <el-button @click="handleFixAvailableQuantityClick(select_batch_detail)" type="text" >修复可用库存的值</el-button>
                                </span>

                                <div style="margin-top: 10px;" v-loading="goods_batch_loading">
                                    <template>

                                        <div style="margin-bottom: 10px;" v-if="showAvailableQuantity">
                                            <div>
                                                [ 可用库存 ] {{GoodsBatchDetailHistoryAvailableQuantity}}
                                            </div>
                                            <div>
                                                [ 冻结库存 ] {{GoodsBatchDetailHistoryOutFrozenQuantity}}
                                            </div>
                                        </div>

                                        <el-table :data="GoodsBatchDetailHistoryList" border style="width: 100%" :row-style="{ height: 10+'px'}" :cell-style="{padding:0+'px'}"> <!-- height="250" -->


                                            <el-table-column fixed label="序号" type="index" width="90">
                                                <template slot-scope="scope">
                                                    <span v-if="scope.row.hasError == 1">
                                                        <span style="color: red;">{{scope.$index + 1}}</span>
                                                    </span>
                                                    <span v-else>
                                                        {{scope.$index + 1}}
                                                    </span>
                                                </template>
                                            </el-table-column>

                                            <el-table-column align="center" prop="beforeQuantity" label="期初库存" width="100"></el-table-column>
                                            <el-table-column align="left" label="操作数量" width="100">
                                                <template slot-scope="scope">
                                                    <span v-if="scope.row.storageCategory == 0">
                                                        <span>加{{ scope.row.quantity }}</span>
                                                    </span>
                                                    <span v-else>
                                                        <span>减{{ scope.row.quantity }}</span>
                                                    </span>
                                                </template>
                                            </el-table-column>
                                            <el-table-column align="center" prop="afterQuantity" label="期末库存" ></el-table-column>
                                            <el-table-column align="center" prop="batchDetailsLogDesc" label="操作类型" ></el-table-column>
                                            <el-table-column align="center" prop="storageNo" label="出入库单号" width="180"></el-table-column>
                                            <el-table-column align="center" prop="sourceOrderNo" label="源单号" width="180"></el-table-column>
                                            <el-table-column align="center" prop="createTime" label="创建时间" width="200"></el-table-column>
                                            <el-table-column align="center" label="说明" >
                                                <template slot-scope="scope">
                                                        <span v-if="scope.row.hasError == 1">
                                                            <span style="color: red;">有问题</span>
                                                        </span>
                                                        <span v-if="scope.row.hasError == 0 && scope.row.hasNegative == 1">
                                                            <span style="color: orange;">有负数</span>
                                                        </span>
                                                </template>
                                            </el-table-column>
                                            <!--
                                            <el-table-column align="center" label="操作">
                                                <template slot-scope="scope">
                                                    <span v-if="scope.row.hasError == 1 || (scope.row.hasError == 0 && scope.row.hasNegative == 1)">
                                                        <el-link type="primary" :underline="false" @click="handleFixStockRowClick(select_batch_detail, scope.row.batchDetailsLogId, scope.row.index)">修复该行及以上数据</el-link>
                                                    </span>
                                                </template>
                                            </el-table-column> -->
                                        </el-table>

                                        <div v-if="fix_error != ''" style="margin-top: 20px;">
                                            [ 修复结果 ] {{fix_error}}
                                        </div>

                                    </template>
                                </div>


                            </el-dialog>

                            <el-dialog :title="'[' + DETAIL_INDEX + '][ ' + GoodsName_Batch + ' ] 商品名称历史记录'" :visible.sync="GoodsNameClick_dialogVisible" :show-close="false" width="80%">

                                <div style="margin-top: 10px;" >
                                    <template>
                                        <el-table :data="nameHistoryList" border style="width: 100%" :row-style="{ height: 10+'px'}" :cell-style="{padding:0+'px'}"> <!-- height="250" -->

                                            <el-table-column fixed label="序号" type="index" width="50">
                                                <template slot-scope="scope">
                                                    {{scope.$index + 1}}
                                                </template>
                                            </el-table-column>
                                            <el-table-column align="center" prop="goodsName" label="商品名称" width="360"></el-table-column>
                                            <el-table-column align="center" prop="goodsUnit" label="单位" ></el-table-column>
                                            <el-table-column align="center" prop="goodsSpec" label="规格" ></el-table-column>
                                            <el-table-column align="center" prop="version" label="版本" ></el-table-column>
                                            <el-table-column align="center" prop="createTimeStr" label="创建时间" ></el-table-column>
                                        </el-table>
                                    </template>
                                </div>


                            </el-dialog>

                            <el-dialog :title="'[' + DETAIL_INDEX + '][ ' + GoodsName_Batch + ' ] 库存冻结记录'" :visible.sync="GoodsFrozenClick_dialogVisible" :show-close="false" width="75%">

                                <div style="margin-top: 10px;" v-loading="goods_frozen_loading">
                                    <template>
                                        <el-table :data="frozenList" border style="width: 100%" :row-style="{ height: 10+'px'}" :cell-style="{padding:0+'px'}"> <!-- height="250" -->

                                            <el-table-column fixed label="序号" type="index" width="50">
                                                <template slot-scope="scope">
                                                    {{scope.$index + 1}}
                                                </template>
                                            </el-table-column>
                                            <el-table-column align="center" label="出库单号" width="180">
                                                <template slot-scope="scope">
                                                    <el-link type="primary" :href="'store_storage.html?storeStorageNo='+scope.row.storageNo" :underline="false" target="_blank">{{scope.row.storageNo}}</el-link>
                                                </template>
                                            </el-table-column>
                                            <el-table-column align="center" prop="sourceOrderNo" label="源单号" width="180"></el-table-column>
                                            <el-table-column align="center" prop="expectQuantity" label="冻结数量" width="100"></el-table-column>
                                            <el-table-column align="center" prop="batchNo" label="冻结批次号" width="180"></el-table-column>
                                            <el-table-column align="center" prop="batchDetailsId" label="冻结批次明细ID" ></el-table-column>
                                            <el-table-column align="center" prop="createTime" label="创建时间" width="200"></el-table-column>
                                            <el-table-column align="center" prop="updateTime" label="更新时间" width="200"></el-table-column>
                                        </el-table>
                                    </template>
                                </div>
                            </el-dialog>

                            <el-dialog :title="'[' + DETAIL_INDEX + '][ ' + GoodsName_Batch + ' ] 已售库存和待调拨数量'" :visible.sync="GoodsSoldClick_dialogVisible" :show-close="false" width="50%">

                                <div style="margin-top: 10px;" >
                                    <template>
                                        <el-table :data="soldOrderList" border style="width: 100%" :row-style="{ height: 10+'px'}" :cell-style="{padding:0+'px'}"> <!-- height="250" -->

                                            <el-table-column fixed label="序号" type="index" width="50">
                                                <template slot-scope="scope">
                                                    {{scope.$index + 1}}
                                                </template>
                                            </el-table-column>
                                            <el-table-column align="center" prop="type" label="类型" width="180"></el-table-column>
                                            <el-table-column align="center" prop="orderNo" label="单号" width="180"></el-table-column>
                                            <el-table-column align="center" prop="quantity" label="数量" ></el-table-column>
                                        </el-table>
                                    </template>
                                </div>
                            </el-dialog>
                        </div>

                        <div style="margin-top: 15px;">
                            <el-alert title="说明" type="warning" style="width: 40%;">
                                <template slot='title'>
                                    <div>说明</div>
                                    <div>可用库存: 没有被任何单据占用的库存</div>
                                    <div>冻结库存: 被出库单占用,但出库单还没有确认出库</div>
                                    <div>可售库存 = 库存数量(可用库存+冻结库存)-待出库数量-已售库存-过期库存-待调拨数量</div>
                                    <div>已售库存 = 订货数量 - 已出库数量 - 出库中数量 - 未出库退货数(已退货处理)</div>
                                </template>
                            </el-alert>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 10px;">
                        <el-pagination
                                background
                                layout="prev, pager, next"
                                :current-page.sync="curPage"
                                :total="total" @current-change="handleCurrentChange">
                        </el-pagination>
                    </div>
                </div>
            </el-form>
        </div>



    </section>

</div>

<script type="text/javascript">

        var host = window.host
        var _env = window.env

        var Main = {
            data: function() {
                return {

                    env: _env,

                    select_warehouse: '',
                    EnterpriseOptions: [],
                    WarehouseOptions: [],

                    goodsName: '',
                    goodsOwnerName: '',
                    warehouse_owner_goods_code: '',
                    business_no: '',

                    swogList: [],

                    loading: false,

                    total: 0,
                    curPage: 1,

                    goods_batch_loading: false,
                    goods_frozen_loading: false,

                    GoodsBatchClick_dialogVisible: false,
                    GoodsNameClick_dialogVisible: false,
                    GoodsFrozenClick_dialogVisible: false,
                    GoodsSoldClick_dialogVisible: false,
                    BatchOptions: [],
                    BatchDetailOptions: [],
                    GoodsBatchDetailHistoryList: [],
                    GoodsBatchDetailHistoryErrorTotal: 0,
                    GoodsBatchDetailHistoryAvailableQuantity: 0,
                    GoodsBatchDetailHistoryOutFrozenQuantity: 0,
                    GoodsBatchDetailHistoryLastAfterQuantity: 0,
                    showAvailableQuantity: false,
                    GoodsBatchDetailHistorySQL: '',
                    GoodsBatchDetailHistoryTotal: 0,
                    select_batch: '',
                    select_batch_label: '',
                    select_batch_detail: '',
                    select_batch_detail_label: '',

                    GoodsName_Batch: '',
                    fix_error: '',

                    DETAIL_INDEX: '',

                    on_Submit: 0,

                    frozenList: [],
                    soldOrderList: [],
                    nameHistoryList: [],


                }
            },
            created: function () {

                // 获取所有仓库
                axios({
                    url: host + '/tools/getAllWarehouse',
                    method: 'GET',
                    params: { },
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                })
                .then(response => {

                    WarehouseList = response.data

                    for (i = 0; i < WarehouseList.length; i++) {
                        label = WarehouseList[i]['warehouseName']
                        value = WarehouseList[i]['warehouseCode']
                        this.WarehouseOptions.push({'label': label, 'value': value})
                    }

                }, error => {
                    this.$message({
                      message: '查询仓库失败',
                      type: 'warning'
                    });
                })

            },
            methods: {
                // 查询
                onSubmit(curPage) {
                    if (curPage < 0) {
                        this.on_Submit = curPage
                    }

                    this.swogList = []
                    _warehouseCode = this.select_warehouse
                    _goodsName = this.goodsName
                    _goodsOwnerName = this.goodsOwnerName
                    _warehouse_owner_goods_code = this.warehouse_owner_goods_code
                    _business_no = this.business_no
                    if (this.on_Submit == -1) {
                        /*
                        if (!this.select_warehouse) {
                            this.$message({
                                message: '请选择仓库',
                                type: 'warning'
                            });
                            return;
                        }*/
                        _warehouse_owner_goods_code = ''
                        _business_no = ''
                    } else if (this.on_Submit == -2) {
                        if (!this.warehouse_owner_goods_code) {
                            this.$message({
                                message: '请输入三方编码',
                                type: 'warning'
                            });
                            return;
                        }
                        _warehouseCode = ''
                        _goodsName = ''
                        _goodsOwnerName = ''
                        _business_no = ''
                    } else if (this.on_Submit == -3) {
                        if (!this.business_no) {
                            this.$message({
                                message: '请输入仓库货主商品编码',
                                type: 'warning'
                            });
                            return;
                        }
                        _warehouseCode = ''
                        _goodsName = ''
                        _goodsOwnerName = ''
                        _warehouse_owner_goods_code = ''
                    }

                    if (curPage == -1 || curPage == -2 || curPage == -3) {
                        this.curPage = 1
                    }
                    this.loading = true
                    axios({
                        url: host + '/tools/getGoodsStockHistory',
                        method: 'GET',
                        params: {
                            warehouseCode: _warehouseCode,
                            goodsName: _goodsName,
                            goodsOwnerName: _goodsOwnerName,
                            warehouse_owner_goods_code: _warehouse_owner_goods_code,
                            business_no: _business_no,
                            curPage: this.curPage
                        },
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {

                        if (response.data.total == 0) {
                            this.loading = false
                            this.$message({
                                message: '未查询到数据',
                                type: 'warning'
                            });
                            this.curPage = 1
                            this.total = 0
                            return
                        }

                        this.swogList = response.data.swogList
                        this.total = response.data.total
                        this.loading = false
                    }, error => {
                        this.loading = false
                        this.$message({
                          message: '查询失败',
                          type: 'warning'
                        });

                        this.curPage = 1
                        this.total = 0
                        this.swogList = []
                    })
                },

                // 修复库存
                onSubmit2() {

                    if (!this.select_warehouse) {
                        this.$message({
                            message: '请选择仓库',
                            type: 'warning'
                        });
                        return;
                    }

                    axios({
                        url: host + '/tools/fixStockByWarehouseOwnerGoods',
                        method: 'GET',
                        params: {
                            warehouseCode: this.select_warehouse,
                            goodsName: this.goodsName,
                            goodsOwnerName: this.goodsOwnerName
                        },
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {
                        this.$message({
                            message: '任务提交成功',
                            type: 'success'
                        });
                    }, error => {
                    })
                },

                // 选择仓库
                selectWarehouse(warehouse) {
                    this.select_warehouse = warehouse
                },

                clearWarehouse() {
                    this.select_warehouse = ''
                },
                clearGoodsName() {
                    this.goodsName = ''
                },
                clearGoodsOwnerName() {
                    this.goodsOwnerName = ''
                },
                clear_warehouse_owner_goods_code() {
                    this.warehouse_owner_goods_code = ''
                },
                clear_business_no() {
                    this.business_no = ''
                },
                handleDetailClick(row) {
                    console.log(row)
                    this.$message({
                        message: '此功能还未开通',
                        type: 'warning'
                    });
                },
                handleCurrentChange(current_page) {
                    this.curPage = current_page
                    this.onSubmit(current_page)
                },

                // 查看商品库存操作记录
                handleGoodsBatchHistoryClick(row) {

                    this.DETAIL_INDEX = row.index

                    this.GoodsBatchClick_dialogVisible = true
                    this.BatchOptions = []
                    this.BatchDetailOptions = []
                    this.GoodsBatchDetailHistoryList = []
                    this.GoodsBatchDetailHistoryErrorTotal = 0
                    this.GoodsBatchDetailHistoryAvailableQuantity = 0
                    this.GoodsBatchDetailHistoryOutFrozenQuantity = 0
                    this.GoodsBatchDetailHistoryLastAfterQuantity = 0
                    this.GoodsBatchDetailHistorySQL = ''
                    this.GoodsBatchDetailHistoryTotal = 0
                    this.select_batch = ''
                    this.select_batch_label = ''
                    this.select_batch_detail = ''
                    this.select_batch_detail_label = ''
                    this.fix_error = ''
                    this.showAvailableQuantity = false

                    this.GoodsName_Batch = row.goodsName

                    axios({
                        url: host + '/tools/getGoodsBatchHistoryByWarehouseOwnerGoodsId',
                        method: 'GET',
                        params: {
                            warehouseOwnerGoodsId: row.warehouseOwnerGoodsId
                        },
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {

                        batchList = response.data.batchList

                        if (batchList.length > 0) {
                            for (i = 0; i < batchList.length; i++) {
                                _label = batchList[i]['batchNo']
                                _value = batchList[i]['batchId']
                                this.BatchOptions.push({'label': _label, 'value': _value})
                            }

                            this.select_batch = this.BatchOptions[0]['value']
                            this.selectBatch()
                        }

                    }, error => {
                        this.$message({
                          message: '查询商品库存操作记录失败',
                          type: 'warning'
                        });
                    })
                },


                // 查看商品历史名称
                handleGoodsNameHistoryClick(row) {
                    this.DETAIL_INDEX = row.index
                    this.GoodsNameClick_dialogVisible = true
                    this.GoodsName_Batch = row.goodsName

                    this.nameHistoryList = [];
                    for (i = 0; i < row.nameHistoryList.length; i++) {
                        goodsName = row.nameHistoryList[i]['goodsName']
                        goodsUnit = row.nameHistoryList[i]['goodsUnit']
                        goodsSpec = row.nameHistoryList[i]['goodsSpec']
                        version = row.nameHistoryList[i]['version']
                        createTimeStr = row.nameHistoryList[i]['createTimeStr']
                        this.nameHistoryList.push({'goodsName': goodsName, 'goodsUnit': goodsUnit, 'goodsSpec': goodsSpec, 'version': version, 'createTimeStr': createTimeStr})
                    }

                },

                // 查看哪些单据冻结的库存
                handleFrozenQuantityClick(row) {

                    this.DETAIL_INDEX = row.index
                    this.GoodsFrozenClick_dialogVisible = true
                    this.GoodsName_Batch = row.goodsName

                    axios({
                        url: host + '/tools/getFrozenStoreStorageByWarehouseOwnerGoodsId',
                        method: 'GET',
                        params: {
                            warehouseOwnerGoodsId: row.warehouseOwnerGoodsId
                        },
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {

                        this.frozenList = response.data.frozenList

                    }, error => {
                        this.$message({
                          message: '查询冻结记录失败',
                          type: 'warning'
                        });
                    })
                },

                // 查看可售库存
                handleSoldQuantityClick(row) {

                    this.DETAIL_INDEX = row.index
                    this.GoodsSoldClick_dialogVisible = true
                    this.GoodsName_Batch = row.goodsName

                    // 已售库存
                    soldScoList = row.soldScoList
                    // 待调拨数量
                    noAllocateList = row.noAllocateList

                    this.soldOrderList = [];
                    if (soldScoList) {
                        for (i = 0; i < soldScoList.length; i++) {
                            customerOrderNo = soldScoList[i]['customerOrderNo']
                            soldQuantity = soldScoList[i]['soldQuantity']
                            this.soldOrderList.push({'type': '已售库存', 'orderNo': customerOrderNo, 'quantity': soldQuantity})
                        }
                    }

                    if (noAllocateList) {
                        for (i = 0; i < noAllocateList.length; i++) {
                            allocateOrderNo = noAllocateList[i]['allocateOrderNo']
                            quantity = noAllocateList[i]['quantity']
                            this.soldOrderList.push({'type': '待调拨数量', 'orderNo': allocateOrderNo, 'quantity': quantity})
                        }
                    }
                },


                // 选中批次
                selectBatch() {

                    for (const obj of this.BatchOptions) {
                        if (obj.value == this.select_batch) {
                            this.select_batch_label = obj.label
                            break
                        }
                    }

                    this.BatchDetailOptions = []
                    this.fix_error = ''
                    this.select_batch_detail = ''
                    this.select_batch_detail_label = ''
                    this.GoodsBatchDetailHistorySQL = ''
                    this.GoodsBatchDetailHistoryList = []
                    this.GoodsBatchDetailHistoryErrorTotal = 0
                    this.GoodsBatchDetailHistoryAvailableQuantity = 0
                    this.GoodsBatchDetailHistoryOutFrozenQuantity = 0
                    this.GoodsBatchDetailHistoryLastAfterQuantity = 0
                    this.showAvailableQuantity = false

                    axios({
                        url: host + '/tools/getBatchDetailList',
                        method: 'GET',
                        params: {
                            batchId: this.select_batch
                        },
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {
                        batchDetailList = response.data.batchDetailList

                        if (batchDetailList.length > 0) {
                            for (i = 0; i < batchDetailList.length; i++) {
                                _label = batchDetailList[i]['warehouseLocationName']
                                _value = batchDetailList[i]['batchDetailsId']
                                this.BatchDetailOptions.push({'label': _label, 'value': _value})
                            }
                            if (batchDetailList.length == 1) {
                                this.select_batch_detail = this.BatchDetailOptions[0]['value']
                                this.selectBatchDetail(1)
                            }
                        } else {
                            this.select_batch_detail = ''
                            this.select_batch_detail_label = ''
                        }

                    }, error => {
                        this.$message({
                          message: '查询商品库存操作记录失败',
                          type: 'warning'
                        });
                    })

                },
                // 选中库位
                selectBatchDetail(clear) {

                    for (const obj of this.BatchDetailOptions) {
                        if (obj.value == this.select_batch_detail) {
                            this.select_batch_detail_label = obj.label
                            break
                        }
                    }

                    this.GoodsBatchDetailHistorySQL = ''
                    if (clear == 1)
                        this.fix_error = ''

                    this.goods_batch_loading = true

                    axios({
                        url: host + '/tools/getBatchDetailHistory',
                        method: 'GET',
                        params: {
                            batchDetailId: this.select_batch_detail
                        },
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {
                        this.GoodsBatchDetailHistoryList = response.data.historyList
                        this.GoodsBatchDetailHistoryErrorTotal = response.data.errorTotal
                        this.GoodsBatchDetailHistoryAvailableQuantity = response.data.availableQuantity
                        this.GoodsBatchDetailHistoryOutFrozenQuantity = response.data.outFrozenQuantity
                        this.GoodsBatchDetailHistoryLastAfterQuantity = response.data.lastAfterQuantity
                        this.GoodsBatchDetailHistorySQL = response.data.sql
                        this.GoodsBatchDetailHistoryTotal = response.data.historyList.length
                        this.goods_batch_loading = false
                        this.showAvailableQuantity = true
                    }, error => {
                        this.$message({
                          message: '查询商品库存操作记录失败',
                          type: 'warning'
                        });
                        this.goods_batch_loading = false
                    })
                },
                // 修复该行及以上数据
                handleFixStockRowClick(select_batch_detail, batch_Detail_Log_Id, index) {
                    this.$confirm('确定修复序号['+index+']及以上库存?', '[ '+this.GoodsName_Batch+' ]', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning',
                        showClose: false
                    }).then(() => {
                        this.fix_error = ''
                        axios({
                            url: host + '/tools/fixStock',
                            method: 'GET',
                            params: {
                                batchDetailId: select_batch_detail,
                                batchDetailsLogId: batch_Detail_Log_Id
                            },
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            }
                        })
                        .then(response => {
                            data = response.data
                            if (data) {
                                this.$message({
                                    message: data,
                                    type: 'warning'
                                });
                                this.fix_error = data
                            } else {
                                this.$message({
                                    message: '修复成功',
                                    type: 'success'
                                });
                            }
                            // 重新刷新该列表
                            this.selectBatchDetail(0)
                        }, error => {
                            this.$message({
                              message: '修复失败',
                              type: 'warning'
                            });
                        })
                    }).catch(() => {
                    });
                },

                // 修复库存
                handleFixStockClick(select_batch_detail) {

                    this.$confirm('确定修复库存?', '[ '+this.GoodsName_Batch+' ]', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning',
                        showClose: false
                    }).then(() => {
                        this.fix_error = ''
                        axios({
                            url: host + '/tools/fixStock',
                            method: 'GET',
                            params: {
                                batchDetailId: select_batch_detail
                            },
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            }
                        })
                        .then(response => {
                            data = response.data
                            if (data) {
                                this.$message({
                                    message: data,
                                    type: 'warning'
                                });
                                this.fix_error = data
                            } else {
                                this.$message({
                                    message: '修复成功',
                                    type: 'success'
                                });
                            }
                            // 重新刷新该列表
                            this.selectBatchDetail(0)
                        }, error => {
                            this.$message({
                              message: '修复失败',
                              type: 'warning'
                            });
                        })
                    }).catch(() => {
                    });
                },
                // 修复可用库存的值
                handleFixAvailableQuantityClick(select_batch_detail) {

                    this.$confirm('确定修复批次['+this.select_batch_label+']库位['+this.select_batch_detail_label+']的可用库存值? 从 '+this.GoodsBatchDetailHistoryAvailableQuantity+' 修改成 '+(this.GoodsBatchDetailHistoryLastAfterQuantity - this.GoodsBatchDetailHistoryOutFrozenQuantity), '[ '+this.GoodsName_Batch+' ]', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning',
                        showClose: false
                    }).then(() => {

                        this.fix_error = ''
                        axios({
                            url: host + '/tools/AvailableQuantity',
                            method: 'GET',
                            params: {
                                batchDetailId: select_batch_detail
                            },
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            }
                        })
                        .then(response => {
                            data = response.data
                            if (data) {
                                this.$message({
                                    message: data,
                                    type: 'warning'
                                });
                                this.fix_error = data
                            } else {
                                this.$message({
                                    message: '修复成功',
                                    type: 'success'
                                });
                            }
                            // 重新刷新该列表
                            this.selectBatchDetail(0)
                        }, error => {
                            this.$message({
                              message: '修复失败',
                              type: 'warning'
                            });
                        })

                    }).catch(() => {
                    });

                },
                copy(data) {
                    let url = data;
                    let oInput = document.createElement('textarea');
                    oInput.value = url;
                    document.body.appendChild(oInput);
                    oInput.select(); // 选择对象
                    document.execCommand("Copy"); // 执行浏览器复制命令
                    this.$message({
                        message: '复制成功',
                        type: 'success'
                    });
                    oInput.remove()
                },
                // 同步库存到OMS
                syncStockToOms(row) {
                    this.$confirm('确定同步库存到OMS?', '[ '+row.goodsName+' ]', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning',
                        showClose: false
                    }).then(() => {
                        axios({
                            url: host + '/tools/syncStockToOms',
                            method: 'GET',
                            params: {
                                warehouseOwnerGoodsId: row.warehouseOwnerGoodsId,
                            },
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            }
                        })
                        .then(response => {
                            if (response.data == 0) {
                                this.$message({
                                    message: '同步成功',
                                    type: 'success'
                                });
                            } else {
                                this.$message({
                                    message: '同步失败',
                                    type: 'warning'
                                });
                            }
                        }, error => {
                            this.$message({
                              message: '同步失败',
                              type: 'warning'
                            });
                        })
                    }).catch(() => {
                    });

                }

            }
        }
        var Ctor = Vue.extend(Main)
        new Ctor().$mount('#app')

    </script>
</body>
</html>
